<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIX Security â€“ COK</title>
<meta name="theme-color" content="#000000" />
<link rel="manifest" href="manifest.json" />
<style>
:root {
  --bg:#fff; --text:#000; --hdr:#eee; --th:#333; --tht:#fff;
  --green:#c8f7c5; --yellow:#fff3b0; --red:#f7c5c5; --grey:#e0e0e0;
}
[data-theme="dark"] {
  --bg:#121212; --text:#fff; --hdr:#1f1f1f; --th:#2c2c2c; --tht:#fff;
  --green:#1f4d2b; --yellow:#5c4b00; --red:#5c1f1f; --grey:#333;
}
body { background:var(--bg); color:var(--text); font-family:Arial; margin:15px; }
h2 { background:var(--hdr); padding:8px; }
table { width:100%; border-collapse:collapse; margin-bottom:30px; }
th,td { border:1px solid #666; padding:6px; text-align:center; }
th { background:var(--th); color:var(--tht); position:sticky; top:0; z-index:2; }
.controls { display:flex; flex-wrap:wrap; gap:8px; justify-content:space-between; margin-bottom:10px; align-items:center; }
button, select { padding:6px 10px; font-size:14px; }
.flight-logo { height:16px; vertical-align:middle; margin-right:4px; }
.onTime { background:var(--green); }
.delay { background:var(--yellow); }
.heavyDelay { background:var(--red); }
.cancelled { background:var(--grey); }
.tabs { display: flex; justify-content: center; margin-bottom:10px; }
.tabs button { margin: 0 5px; }
/* ADMIN MODAL */
#adminModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:999; align-items:center; justify-content:center; }
#adminContent { background:var(--bg); color:var(--text); padding:20px; border-radius:8px; width:92%; max-width:520px; max-height:92vh; overflow:auto; }
.admin-section { margin:20px 0; }
.admin-list { list-style:none; padding:0; }
.admin-list li { display:flex; justify-content:space-between; align-items:center; padding:8px; background:var(--hdr); margin:4px 0; border-radius:4px; }
</style>
</head>
<body>
<div class="controls">
  <select id="stationSelect"></select>
  <button id="adminBtn">ðŸ”§ Admin</button>
  <button id="loadEarlierBtn">Load Earlier Flights</button>
  <button id="notifyBtn">Enable Notifications</button>
  <button id="themeToggle">Dark Mode</button>
</div>
<div class="tabs">
  <button id="flightsTab">ðŸ›¬ <span id="stationTitle">COK</span> FLIGHTS ðŸ›« </button>
  <button id="turnTab">Turnaround Flights</button>
</div>
<div id="flights-section">
<h2>Arrivals â€“ <span id="arrStation">COK</span></h2>
<table id="arrivals-table">
<thead><tr><th>Flight</th><th>Reg</th><th>From</th><th>ETA</th><th>STA</th><th>Aircraft</th><th>Status</th></tr></thead>
<tbody></tbody>
</table>
<h2>Departures â€“ <span id="depStation">COK</span></h2>
<table id="departures-table">
<thead><tr><th>Flight</th><th>Reg</th><th>To</th><th>ETD</th><th>STD</th><th>Aircraft</th><th>Status</th></tr></thead>
<tbody></tbody>
</table>
</div>
<div id="turnarounds-section" style="display:none;">
<h2>Turnaround Flights â€“ <span id="turnStation">COK</span></h2>
<table id="turnarounds-table">
<thead><tr><th>Flight</th><th>Reg</th><th>From</th><th>To</th><th>ETA/ETD</th><th>STA/STD</th><th>Aircraft</th><th>Status</th></tr></thead>
<tbody></tbody>
</table>
</div>
<!-- ADMIN MODAL -->
<div id="adminModal">
  <div id="adminContent">
    <h2>ðŸ”§ Admin â€“ Stations & Airlines</h2>
   
    <div class="admin-section">
      <strong>Stations (IATA)</strong><br>
      <input id="newStation" placeholder="e.g. ccj" style="width:55%">
      <button id="addStationBtn">Add</button>
      <ul id="stationsList" class="admin-list"></ul>
    </div>
    <div class="admin-section">
      <strong>Airlines (2-letter codes)</strong><br>
      <input id="newAirline" placeholder="e.g. VJ" style="width:55%">
      <button id="addAirlineBtn">Add</button>
      <ul id="airlinesList" class="admin-list"></ul>
    </div>
    <div class="admin-section">
      Default Station:
      <select id="defaultStationSelect" style="width:120px"></select>
    </div>
    <button id="saveAdminBtn">ðŸ’¾ Save & Reload</button>
    <button id="resetAdminBtn">Reset to Original (COK only)</button>
    <button id="closeAdminBtn">Close</button>
  </div>
</div>
<script>
/* ================= CONFIG & STORAGE ================= */
const DEFAULT_CONFIG = {
  stations: ["cok"],
  airlines: ["IX","AK","FD","J9","UL","FZ"],
  defaultStation: "cok"
};
let config = JSON.parse(localStorage.getItem("aixSecOpsConfig")) || {...DEFAULT_CONFIG};
let currentStation = config.lastStation || config.defaultStation || "cok";

/* Theme persist */
if (localStorage.getItem("aixTheme") === "dark") document.documentElement.dataset.theme = "dark";

/* ================= ORIGINAL HELPERS (unchanged) ================= */
const BRANDFETCH_CLIENT_ID = "1idBLQ1djCDndBUmUVs";
let baseTimestamp = Math.floor(Date.now() / 1000);
let loadedTimestamps = new Set();
const fetchHeaders = { "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" };
const getEndpoint = (type, ts) =>
  `https://api.flightradar24.com/common/v1/airport.json?code=${currentStation}&plugin-setting[schedule][mode]=${type}&plugin-setting[schedule][timestamp]=${ts}&limit=100`;
const toTime = t => t ? new Date(t * 1000).toLocaleTimeString("en-IN", { timeZone: "Asia/Kolkata", hour: "2-digit", minute: "2-digit", hour12: false }) : "-";
const airlineAllowed = fn => config.airlines.some(a => fn.startsWith(a));
const getLogo = (fn, fl = null) => {
  // Try FlightRadar24 logo first
  if (fl && fl.airline && (fl.airline.logo || fl.airline.image)) return fl.airline.logo || fl.airline.image;
  // Brandfetch fallback (unchanged)
  if (fn.startsWith("AK") || fn.startsWith("FD")) {
    return "https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/AirAsia_New_Logo_%282020%29.svg/768px-AirAsia_New_Logo_%282020%29.svg.png";
  }

   if (fn.startsWith("AI")) {
    return "https://cdn.brandfetch.io/id-PSmaCm4/theme/light/logo.svg?c=1bxid64Mup7aczewSAYMX&t=1715867951334";
  }

let domain = "", format = "png";

  // ================= INDIA (Mainline & Regional) =================
  if (fn.startsWith("AI")) domain = "airindia.com";
  if (fn.startsWith("IX")) domain = "airindiaexpress.com";
  if (fn.startsWith("6E")) domain = "goindigo.in";
  if (fn.startsWith("UK")) domain = "airindia.com"; // Vistara merged with Air India
  if (fn.startsWith("SG")) domain = "spicejet.com";
  if (fn.startsWith("QP")) domain = "akasaair.com";
  if (fn.startsWith("9I")) domain = "allianceair.in";
  if (fn.startsWith("S5")) domain = "starair.in";
  if (fn.startsWith("IC")) domain = "fly91.in";
  if (fn.startsWith("I7")) domain = "indiaoneair.com";
  if (fn.startsWith("S9")) domain = "flybig.in";

  // ================= GULF & MIDDLE EAST =================
  if (fn.startsWith("EK")) domain = "emirates.com";
  if (fn.startsWith("EY")) domain = "etihad.com";
  if (fn.startsWith("QR")) domain = "qatarairways.com";
  if (fn.startsWith("SV")) domain = "saudia.com";
  if (fn.startsWith("KU")) domain = "kuwaitairways.com";
  if (fn.startsWith("WY")) domain = "omanair.com";
  if (fn.startsWith("GF")) domain = "gulfair.com";
  if (fn.startsWith("J9")) domain = "jazeeraairways.com";
  if (fn.startsWith("FZ")) { domain = "flydubai.com"; format = "svg"; }
  if (fn.startsWith("G9")) domain = "airarabia.com";
  if (fn.startsWith("3L")) domain = "airarabia.com"; // Air Arabia Abu Dhabi
  if (fn.startsWith("NP")) domain = "flyadeal.com";
  if (fn.startsWith("XY")) domain = "flynas.com";
  if (fn.startsWith("OV")) domain = "salamair.com";
  if (fn.startsWith("LY")) domain = "elal.com";

  // ================= ASIA & OCEANIA =================
  if (fn.startsWith("UL")) domain = "srilankan.com";
  if (fn.startsWith("SQ")) domain = "singaporeair.com";
  if (fn.startsWith("TR")) domain = "scoot.com";
  if (fn.startsWith("MH")) domain = "malaysiaairlines.com";
  if (fn.startsWith("OD")) domain = "batikair.com";
  if (fn.startsWith("AK")) domain = "airasia.com";
  if (fn.startsWith("FD")) domain = "airasia.com";
  if (fn.startsWith("TG")) domain = "thaiairways.com";
  if (fn.startsWith("SL")) domain = "lionairthai.com";
  if (fn.startsWith("VN")) domain = "vietnamairlines.com";
  if (fn.startsWith("VJ")) domain = "vietjetair.com";
  if (fn.startsWith("BI")) domain = "flyroyalbrunei.com";
  if (fn.startsWith("CX")) domain = "cathaypacific.com";
  if (fn.startsWith("JL")) domain = "jal.co.jp";
  if (fn.startsWith("NH")) domain = "ana.co.jp";
  if (fn.startsWith("OZ")) domain = "flyasiana.com";
  if (fn.startsWith("KE")) domain = "koreanair.com";
  if (fn.startsWith("GA")) domain = "garuda-indonesia.com";
  if (fn.startsWith("PR")) domain = "philippineairlines.com";
  if (fn.startsWith("BR")) domain = "evaair.com";
  if (fn.startsWith("QF")) domain = "qantas.com";
  if (fn.startsWith("NZ")) domain = "airnewzealand.com";

  // ================= SOUTH ASIA (Neighboring) =================
  if (fn.startsWith("PK")) domain = "piac.com.pk";
  if (fn.startsWith("BG")) domain = "biman-airlines.com";
  if (fn.startsWith("BS")) domain = "us-banglaairlines.com";
  if (fn.startsWith("KB")) domain = "drukair.com.bt";
  if (fn.startsWith("B3")) domain = "bhutanairlines.bt";
  if (fn.startsWith("RA")) domain = "nepalairlines.com.np";

  // ================= EUROPE =================
  if (fn.startsWith("LH")) domain = "lufthansa.com";
  if (fn.startsWith("LX")) domain = "swiss.com";
  if (fn.startsWith("OS")) domain = "austrian.com";
  if (fn.startsWith("AF")) domain = "airfrance.com";
  if (fn.startsWith("KL")) domain = "klm.com";
  if (fn.startsWith("BA")) domain = "britishairways.com";
  if (fn.startsWith("VS")) domain = "virginatlantic.com";
  if (fn.startsWith("AY")) domain = "finnair.com";
  if (fn.startsWith("TK")) domain = "turkishairlines.com";
  if (fn.startsWith("AZ")) domain = "ita-airways.com";
  if (fn.startsWith("IB")) domain = "iberia.com";
  if (fn.startsWith("LO")) domain = "lot.com";
  if (fn.startsWith("SK")) domain = "flysas.com";
  if (fn.startsWith("SN")) domain = "brusselsairlines.com";
  if (fn.startsWith("SU")) domain = "aeroflot.ru";

  // ================= AMERICAS =================
  if (fn.startsWith("UA")) domain = "united.com";
  if (fn.startsWith("AA")) domain = "aa.com";
  if (fn.startsWith("DL")) domain = "delta.com";
  if (fn.startsWith("AC")) domain = "aircanada.com";
  if (fn.startsWith("B6")) domain = "jetblue.com";
  if (fn.startsWith("CM")) domain = "copaair.com";
  if (fn.startsWith("LA")) domain = "latamairlines.com";

  // ================= AFRICA =================
  if (fn.startsWith("ET")) domain = "ethiopianairlines.com";
  if (fn.startsWith("KQ")) domain = "kenya-airways.com";
  if (fn.startsWith("MS")) domain = "egyptair.com";
  if (fn.startsWith("MK")) domain = "airmauritius.com";
  if (fn.startsWith("WB")) domain = "rwandair.com";
  if (fn.startsWith("SA")) domain = "flysaa.com";

  // ================= CARGO =================
  if (fn.startsWith("5X")) domain = "ups.com";
  if (fn.startsWith("FX")) domain = "fedex.com";
  if (fn.startsWith("7L")) domain = "silkwaywest.com";
  if (fn.startsWith("CV")) domain = "cargolux.com";
  if (fn.startsWith("CK")) domain = "airchinacargo.com";
  if (fn.startsWith("BZ")) domain = "bluedartaviation.com";
  if (fn.startsWith("6P")) domain = "pradhaanairexpress.in";
  if (fn.startsWith("QO")) domain = "quikjet.co.in";

  if (!domain) return "";
  return `https://cdn.brandfetch.io/${domain}/logo.${format}?w=400&h=120&c=${BRANDFETCH_CLIENT_ID}`;
};
const delayMinutes = (sch, est) => sch && est ? Math.round((est - sch) / 60) : 0;
const rowClass = (status, delay) => {
  if (status?.toLowerCase()?.includes("cancel")) return "cancelled";
  if (delay > 30) return "heavyDelay";
  if (delay > 5) return "delay";
  return "onTime";
};
const withinTimeWindow = (type, sch, est, act) => {
  const now = Math.floor(Date.now() / 1000);
  const oneHr = 3600;
  const twentyHr = now + 20 * oneHr;
  const t = sch || est || 0;
  const inWindow = t >= now - oneHr && t <= twentyHr;
  const delayed = sch && now > sch && (!act || act > now) && (est > now || !est);
  let completed = false;
  if (type === "arrivals") completed = act && act >= now - 1200;
  else completed = act && act >= now - 300;
  return inWindow || delayed || completed;
};
const cleanupFlights = (type, tbody) => {
  const now = Math.floor(Date.now() / 1000);
  Array.from(tbody.rows).forEach(row => {
    const act = parseInt(row.dataset.act) || 0;
    if (type === "arrivals") {
      if (act && act < now - 1200) row.remove();
    } else {
      if (act && act < now) row.remove();
    }
  });
};
const sortTable = (tableId) => {
  const table = document.getElementById(tableId);
  const tbody = table.tBodies[0];
  const rows = Array.from(tbody.rows);
  rows.sort((a, b) => (parseInt(a.dataset.sch) || 0) - (parseInt(b.dataset.sch) || 0));
  rows.forEach(row => tbody.appendChild(row));
};
const notifyDelay = (fn, message) => {
  if (Notification.permission === 'granted') new Notification(`Flight ${fn}: ${message}`);
};
/* ================= LOAD FLIGHTS (exactly your original logic) ================= */
async function loadFlights(type, ts, append = true) {
  if (loadedTimestamps.has(type + ts)) return;
  loadedTimestamps.add(type + ts);
  const res = await fetch(getEndpoint(type, ts), { headers: fetchHeaders });
  const data = await res.json();
  const flights = data?.result?.response?.airport?.pluginData?.schedule?.[type]?.data || [];
  const tbody = document.querySelector(`#${type}-table tbody`);
  if (!append) tbody.innerHTML = "";
  flights.forEach(f => {
    const fl = f.flight;
    const fn = fl?.identification?.number?.default || "";
    if (!airlineAllowed(fn)) return;
    const isDep = type === "departures";
    const sch = isDep ? fl.time.scheduled?.departure : fl.time.scheduled?.arrival;
    const est = isDep ? fl.time.estimated?.departure : fl.time.estimated?.arrival;
    const act = isDep ? fl.time.actual?.departure : fl.time.actual?.arrival;
    if (!withinTimeWindow(type, sch, est, act)) return;
    const flightId = fl.identification?.id || fn;
    const existing = tbody.querySelector(`tr[data-flight-id="${flightId}"]`);
    const dly = delayMinutes(sch, est);
    const statusText = fl.status?.text || "-";
    const className = rowClass(statusText, dly);
    if (existing) {
      const oldClass = existing.className;
      const oldEtaText = existing.cells[3].innerHTML;
      let oldDly = 0;
      if (oldEtaText.includes('(+')) oldDly = parseInt(oldEtaText.split('(+')[1].split(')')[0]) || 0;
      existing.cells[3].innerHTML = `${toTime(est) || toTime(sch)} ${dly > 0 ? `(+${dly})` : ""}`;
      existing.cells[6].innerHTML = statusText;
      existing.className = className;
      existing.dataset.est = est || 0;
      existing.dataset.act = act || 0;
      if (dly > oldDly && dly > 5) {
        const increase = dly - oldDly;
        notifyDelay(fn, `Delay increased by ${increase} minutes to ${dly} minutes total`);
      } else if (className === 'delay' && oldClass === 'onTime') {
        notifyDelay(fn, `Now delayed by ${dly} minutes`);
      } else if (className === 'heavyDelay' && (oldClass === 'onTime' || oldClass === 'delay')) {
        notifyDelay(fn, `Now heavily delayed by ${dly} minutes`);
      }
      return;
    }
    const tr = document.createElement("tr");
    tr.dataset.flightId = flightId;
    tr.dataset.sch = sch || 0;
    tr.dataset.est = est || 0;
    tr.dataset.act = act || 0;
    tr.className = className;
    tr.innerHTML = `
      <td><img class="flight-logo" src="${getLogo(fn, fl)}" alt="${fn} logo">${fn}</td>
      <td>${fl.aircraft?.registration || "-"}</td>
      <td>${isDep ? (fl.airport.destination?.code?.iata || "-") : (fl.airport.origin?.code?.iata || "-")}</td>
      <td>${toTime(est) || toTime(sch)} ${dly > 0 ? `(+${dly})` : ""}</td>
      <td>${toTime(sch)}</td>
      <td>${fl.aircraft?.model?.text || "-"}</td>
      <td>${statusText}</td>`;
    tbody.appendChild(tr);
  });
  cleanupFlights(type, tbody);
  sortTable(`${type}-table`);
}
/* ================= BUILD TURNAROUNDS (exactly your original) ================= */
function buildTurnarounds() {
  const arrivalsRows = Array.from(document.querySelector('#arrivals-table tbody').rows);
  const departuresRows = Array.from(document.querySelector('#departures-table tbody').rows);
  const regToArr = new Map();
  const regToDep = new Map();
  arrivalsRows.forEach(row => {
    const reg = row.cells[1].textContent.trim();
    if (reg === '-' || !reg) return;
    const arr = {
      fn: row.cells[0].textContent.trim().split(' ')[0],
      reg, from: row.cells[2].textContent.trim(),
      eta: parseInt(row.dataset.est) || parseInt(row.dataset.sch) || 0,
      sch: parseInt(row.dataset.sch) || 0,
      act: parseInt(row.dataset.act) || 0,
      aircraft: row.cells[5].textContent.trim(),
      status: row.cells[6].textContent.trim()
    };
    if (!regToArr.has(reg)) regToArr.set(reg, []);
    regToArr.get(reg).push(arr);
  });
  departuresRows.forEach(row => {
    const reg = row.cells[1].textContent.trim();
    if (reg === '-' || !reg) return;
    const dep = {
      fn: row.cells[0].textContent.trim().split(' ')[0],
      reg, to: row.cells[2].textContent.trim(),
      etd: parseInt(row.dataset.est) || parseInt(row.dataset.sch) || 0,
      sch: parseInt(row.dataset.sch) || 0,
      act: parseInt(row.dataset.act) || 0,
      aircraft: row.cells[5].textContent.trim(),
      status: row.cells[6].textContent.trim()
    };
    if (!regToDep.has(reg)) regToDep.set(reg, []);
    regToDep.get(reg).push(dep);
  });
  const tbody = document.querySelector('#turnarounds-table tbody');
  tbody.innerHTML = '';
  for (const reg of regToArr.keys()) {
    if (!regToDep.has(reg)) continue;
    const arrs = regToArr.get(reg).sort((a, b) => a.eta - b.eta);
    const deps = regToDep.get(reg).sort((a, b) => a.etd - b.etd);
    for (const arr of arrs) {
      for (const dep of deps) {
        if (dep.etd > arr.eta && dep.etd - arr.eta <= 2.5 * 3600) {
          const arrDly = delayMinutes(arr.sch, arr.eta);
          const depDly = delayMinutes(dep.sch, dep.etd);
          const maxDly = Math.max(arrDly, depDly);
          const statusText = `${arr.status} / ${dep.status}`;
          const className = rowClass(statusText, maxDly);
          const arrEtaStr = `${toTime(arr.eta)} ${arrDly > 0 ? `(+${arrDly})` : ''}`;
          const depEtdStr = `${toTime(dep.etd)} ${depDly > 0 ? `(+${depDly})` : ''}`;
          const logoSrc = getLogo(arr.fn);
          const tr = document.createElement('tr');
          tr.dataset.sch = arr.sch || 0;
          tr.className = className;
          tr.innerHTML = `
            <td><img class="flight-logo" src="${logoSrc}" alt="${arr.fn} logo">${arr.fn} / ${dep.fn}</td>
            <td>${reg}</td>
            <td>${arr.from}</td>
            <td>${dep.to}</td>
            <td>${arrEtaStr} / ${depEtdStr}</td>
            <td>${toTime(arr.sch)} / ${toTime(dep.sch)}</td>
            <td>${arr.aircraft}</td>
            <td>${statusText}</td>`;
          tbody.appendChild(tr);
        }
      }
    }
  }
  sortTable('turnarounds-table');
}
/* ================= AUTO LOADER ================= */
async function loadInitialWindow() {
  baseTimestamp = Math.floor(Date.now() / 1000);
  for (let i = -1; i <= 4; i++) {
    const ts = baseTimestamp + i * 6 * 3600;
    await Promise.all([loadFlights("arrivals", ts), loadFlights("departures", ts)]);
  }
  buildTurnarounds();
}
/* ================= ADMIN & STATION SWITCH ================= */
function loadConfigIntoUI() {
  const sel = document.getElementById('stationSelect');
  sel.innerHTML = '';
  config.stations.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s.toUpperCase();
    if (s === currentStation) opt.selected = true;
    sel.appendChild(opt);
  });
  const defSel = document.getElementById('defaultStationSelect');
  defSel.innerHTML = '';
  config.stations.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s.toUpperCase();
    if (s === config.defaultStation) opt.selected = true;
    defSel.appendChild(opt);
  });
  // lists
  const sl = document.getElementById('stationsList');
  sl.innerHTML = config.stations.map((s,i) => `<li>${s.toUpperCase()} <button data-type="station" data-i="${i}">Remove</button></li>`).join('');
  const al = document.getElementById('airlinesList');
  al.innerHTML = config.airlines.map((a,i) => `<li>${a} <button data-type="airline" data-i="${i}">Remove</button></li>`).join('');
}
document.getElementById('stationSelect').onchange = e => {
  currentStation = e.target.value;
  config.lastStation = currentStation;   // <-- added for persist
  localStorage.setItem("aixSecOpsConfig", JSON.stringify(config));  // <-- added
  document.getElementById('stationTitle').textContent = currentStation.toUpperCase();
  document.getElementById('arrStation').textContent = currentStation.toUpperCase();
  document.getElementById('depStation').textContent = currentStation.toUpperCase();
  document.getElementById('turnStation').textContent = currentStation.toUpperCase();
  document.title = `AIX Security â€“ ${currentStation.toUpperCase()}`;
  loadedTimestamps.clear();
  loadInitialWindow();
};
document.getElementById('adminBtn').onclick = () => {
  loadConfigIntoUI();
  document.getElementById('adminModal').style.display = 'flex';
};
document.getElementById('addStationBtn').onclick = () => {
  let val = document.getElementById('newStation').value.trim().toLowerCase();
  if (val && !config.stations.includes(val)) config.stations.push(val);
  loadConfigIntoUI();
};
document.getElementById('addAirlineBtn').onclick = () => {
  let val = document.getElementById('newAirline').value.trim().toUpperCase();
  if (val && !config.airlines.includes(val)) config.airlines.push(val);
  loadConfigIntoUI();
};
document.getElementById('saveAdminBtn').onclick = () => {
  config.defaultStation = document.getElementById('defaultStationSelect').value;
  localStorage.setItem("aixSecOpsConfig", JSON.stringify(config));
  location.reload();
};
document.getElementById('resetAdminBtn').onclick = () => {
  if (confirm("Reset to original COK + airlines?")) {
    localStorage.removeItem("aixSecOpsConfig");
    location.reload();
  }
};
document.getElementById('closeAdminBtn').onclick = () => document.getElementById('adminModal').style.display = 'none';
// Remove buttons
document.addEventListener('click', e => {
  if (e.target.tagName === 'BUTTON' && e.target.dataset.type) {
    const type = e.target.dataset.type;
    const i = parseInt(e.target.dataset.i);
    if (type === "station") config.stations.splice(i,1);
    else config.airlines.splice(i,1);
    loadConfigIntoUI();
  }
});
/* ================= ORIGINAL CONTROLS & START ================= */
document.getElementById("loadEarlierBtn").onclick = async () => {
  baseTimestamp -= 6 * 3600;
  await loadFlights("arrivals", baseTimestamp);
  await loadFlights("departures", baseTimestamp);
  buildTurnarounds();
};
document.getElementById("notifyBtn").onclick = async () => {
  if (Notification.permission === 'default') {
    const permission = await Notification.requestPermission();
    alert(permission === 'granted' ? 'Notifications enabled' : 'Notifications denied');
  } else if (Notification.permission === 'granted') {
    alert('Notifications already enabled');
  } else {
    alert('Notifications denied. Please change in browser settings.');
  }
};
document.getElementById("themeToggle").onclick = () => {
  document.documentElement.dataset.theme = document.documentElement.dataset.theme === "dark" ? "light" : "dark";
  localStorage.setItem("aixTheme", document.documentElement.dataset.theme);  // <-- added for persist
};
const sections = {
  flights: document.getElementById('flights-section'),
  turn: document.getElementById('turnarounds-section')
};
function showSection(sec) {
  Object.values(sections).forEach(s => s.style.display = 'none');
  sections[sec].style.display = 'block';
}
document.getElementById('flightsTab').onclick = () => showSection('flights');
document.getElementById('turnTab').onclick = () => showSection('turn');
/* ================= START ================= */
loadConfigIntoUI();
document.getElementById('stationTitle').textContent = currentStation.toUpperCase();
document.getElementById('arrStation').textContent = currentStation.toUpperCase();
document.getElementById('depStation').textContent = currentStation.toUpperCase();
document.getElementById('turnStation').textContent = currentStation.toUpperCase();
document.title = `AIX Security â€“ ${currentStation.toUpperCase()}`;
loadInitialWindow();
setInterval(loadInitialWindow, 30000);
showSection('flights');
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log("SW registered", reg))
      .catch(err => console.error("SW registration failed:", err));
  });
}
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const installBtn = document.createElement("button");
  installBtn.textContent = "Install App";
  installBtn.style = "position:fixed;bottom:10px;right:10px;z-index:1000;";
  installBtn.onclick = () => {
    installBtn.remove();
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(choice => {
      if (choice.outcome === 'accepted') console.log("App installed");
      deferredPrompt = null;
    });
  };
  document.body.appendChild(installBtn);
});
</script>
</body>
</html>